<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sheet Data Retriever</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="bg-gray-50 p-8">

    <div class="max-w-6xl mx-auto bg-white p-6 rounded-lg shadow-md">
        <h1 class="text-2xl font-bold mb-6 text-gray-800">Google Sheet Data Retriever</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div>
                <label class="block text-sm font-medium text-gray-700">Google Sheet ID</label>
                <input type="text" id="sheetId" placeholder="Enter Sheet ID..." class="mt-1 block w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-blue-500 focus:border-blue-500">
                <p class="text-xs text-gray-500 mt-1">Ensure the sheet is "Published to Web".</p>
            </div>
            <div class="flex items-end">
                <button onclick="fetchData()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition">Fetch Data</button>
            </div>
        </div>

        <hr class="my-6">

        <div id="controls" class="hidden space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Filter Column (e.g., Column 1)</label>
                    <select id="filterColumn" class="mt-1 block w-full border border-gray-300 rounded-md p-2"></select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Filter Value (e.g., "C")</label>
                    <input type="text" id="filterValue" placeholder="Type to filter..." class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                </div>
                <div class="flex items-end space-x-2">
                    <button onclick="applyFilters()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Apply Filter</button>
                    <button onclick="downloadPDF()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Download PDF</button>
                </div>
            </div>
        </div>

        <div class="mt-8 overflow-x-auto">
            <table id="dataTable" class="min-w-full divide-y divide-gray-200 border text-sm">
                <thead class="bg-gray-100" id="tableHead"></thead>
                <tbody class="divide-y divide-gray-200" id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        let rawData = [];
        let headers = [];

        async function fetchData() {
            const id = document.getElementById('sheetId').value.trim();
            if (!id) return alert("Please enter a Sheet ID");

            // Fetching CSV format from published sheet
            const url = `https://docs.google.com/spreadsheets/d/${id}/export?format=csv`;

            try {
                const response = await fetch(url);
                const data = await response.text();
                processData(data);
                document.getElementById('controls').classList.remove('hidden');
            } catch (error) {
                alert("Error fetching data. Ensure the Sheet ID is correct and Published to Web.");
            }
        }

        function processData(csvText) {
            const rows = csvText.split('\n').map(row => row.split(','));
            // Standardizing headers as Column 1, Column 2...
            headers = rows[0].map((_, i) => `Column ${i + 1}`);
            rawData = rows.slice(1); // Actual data rows
            
            populateFilterOptions();
            renderTable(rawData);
        }

        function populateFilterOptions() {
            const select = document.getElementById('filterColumn');
            select.innerHTML = headers.map((h, i) => `<option value="${i}">${h}</option>`).join('');
        }

        function renderTable(dataRows) {
            const head = document.getElementById('tableHead');
            const body = document.getElementById('tableBody');

            head.innerHTML = `<tr>${headers.map(h => `<th class="px-4 py-2 text-left font-semibold border">${h}</th>`).join('')}</tr>`;
            
            body.innerHTML = dataRows.map(row => 
                `<tr>${row.map(cell => `<td class="px-4 py-2 border">${cell}</td>`).join('')}</tr>`
            ).join('');
        }

        function applyFilters() {
            const colIdx = document.getElementById('filterColumn').value;
            const val = document.getElementById('filterValue').value.toLowerCase().trim();

            const filtered = rawData.filter(row => {
                return row[colIdx] && row[colIdx].toLowerCase().includes(val);
            });

            renderTable(filtered);
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); // Landscape for many columns

            const table = document.getElementById('dataTable');
            doc.autoTable({ html: '#dataTable' });
            doc.save('sheet_data.pdf');
        }
    </script>
</body>
</html>
